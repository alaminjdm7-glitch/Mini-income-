<?php
/*
Telegram Bot for Gmail Apply System (DB Free)
Author: Alamin
*/

// --- CONFIGURATION ---
$botToken = "YOUR_BOT_TOKEN";      // Bot Token
$adminId  = "YOUR_TELEGRAM_ID";    // Admin Telegram ID
$apiUrl   = "https://api.telegram.org/bot$botToken/";

// --- HELPER FUNCTION ---
function sendMessage($chatId, $text, $replyMarkup = null){
    global $apiUrl;
    $data = [
        'chat_id' => $chatId,
        'text' => $text,
        'parse_mode' => 'HTML'
    ];
    if($replyMarkup){
        $data['reply_markup'] = json_encode($replyMarkup);
    }
    file_get_contents($apiUrl . "sendMessage?" . http_build_query($data));
}

// --- GET UPDATE ---
$update = json_decode(file_get_contents("php://input"), TRUE);
$message = $update['message'] ?? null;
$callback_query = $update['callback_query'] ?? null;

// --- HANDLE CALLBACK BUTTON ---
if($callback_query){
    $chatId = $callback_query['from']['id'];
    $data = $callback_query['data'];
    $messageId = $callback_query['message']['message_id'];
    $userId = $callback_query['from']['id'];
    
    // Split data for action
    $parts = explode("|", $data);
    $action = $parts[0];  // accept, reject, sendgmail
    $targetUser = $parts[1] ?? null;

    if($action == "sendgmail" && $targetUser){
        sendMessage($chatId, "ðŸ“§ User $targetUser à¦à¦° à¦œà¦¨à§à¦¯ Gmail à¦²à¦¿à¦–à§à¦¨ (Email à¦à¦¬à¦‚ Password):");
        file_put_contents("apply_step_$targetUser.txt", "await_gmail");
    }
    if($action == "accept" && $targetUser){
        sendMessage($targetUser, "âœ… à¦†à¦ªà¦¨à¦¾à¦° Gmail à¦•à¦¾à¦œ Accept à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦à¥¤");
        sendMessage($chatId, "User $targetUser Accept à¦•à¦°à¦¾ à¦¹à¦²à§‹à¥¤");
        @unlink("apply_step_$targetUser.txt");
    }
    if($action == "reject" && $targetUser){
        sendMessage($targetUser, "âŒ à¦†à¦ªà¦¨à¦¾à¦° Gmail à¦•à¦¾à¦œ à¦¬à¦¾à¦¤à¦¿à¦² à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ à¦†à¦¬à¦¾à¦° Submit à¦•à¦°à§à¦¨à¥¤");
        sendMessage($chatId, "User $targetUser Reject à¦•à¦°à¦¾ à¦¹à¦²à§‹à¥¤");
        @unlink("apply_step_$targetUser.txt");
    }
    exit;
}

// --- HANDLE USER MESSAGE ---
if($message){
    $chatId = $message['chat']['id'];
    $text = $message['text'];
    
    // Step storage (Memory via temp file)
    $stepFile = "apply_step_$chatId.txt";
    $step = file_exists($stepFile) ? file_get_contents($stepFile) : null;

    // --- START ---
    if($text == "/start"){
        sendMessage($chatId, "ðŸ‘‹ à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®! Gmail à¦•à¦¾à¦œà§‡à¦° à¦œà¦¨à§à¦¯ Apply à¦•à¦°à¦¤à§‡ à¦¨à¦¿à¦šà§‡à¦° à¦¬à¦¾à¦Ÿà¦¨ à¦šà¦¾à¦ªà§à¦¨à¥¤", [
            'inline_keyboard' => [
                [['text'=>"ðŸ“§ Gmail Apply", 'callback_data'=>"apply|$chatId"]]
            ]
        ]);
        exit;
    }

    // --- APPLY FLOW ---
    if($step == "await_name"){
        file_put_contents($stepFile, "await_phone|$text"); // save name
        sendMessage($chatId, "à¦†à¦ªà¦¨à¦¾à¦° à¦®à§‹à¦¬à¦¾à¦‡à¦² à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦²à¦¿à¦–à§à¦¨:");
        exit;
    }
    if(strpos($step, "await_phone") === 0){
        $name = explode("|", $step)[1];
        file_put_contents($stepFile, "await_job|$name|$text"); // save name + phone
        sendMessage($chatId, "à¦•à§‹à¦¨ à¦•à¦¾à¦œ à¦•à¦°à¦¤à§‡ à¦šà¦¾à¦¨ à¦²à¦¿à¦–à§à¦¨ (à¦‰à¦¦à¦¾: Gmail):");
        exit;
    }
    if(strpos($step, "await_job") === 0){
        $parts = explode("|", $step);
        $name = $parts[1];
        $phone = $parts[2];
        $job = $text;

        // Notify Admin
        $keyboard = [
            'inline_keyboard' => [
                [
                    ['text'=>"ðŸ“§ Gmail à¦¦à¦¿à¦¨", 'callback_data'=>"sendgmail|$chatId"],
                    ['text'=>"âŒ Reject", 'callback_data'=>"reject|$chatId"]
                ]
            ]
        ];
        sendMessage($GLOBALS['adminId'], "ðŸ†• à¦¨à¦¤à§à¦¨ Gmail à¦•à¦¾à¦œà§‡à¦° à¦†à¦¬à§‡à¦¦à¦¨\n\nðŸ‘¤ à¦¨à¦¾à¦®: $name\nðŸ“± à¦®à§‹à¦¬à¦¾à¦‡à¦²: $phone\nðŸ›  à¦•à¦¾à¦œ: $job\nðŸ†” User ID: $chatId", $keyboard);

        sendMessage($chatId, "âœ… à¦†à¦ªà¦¨à¦¾à¦° à¦†à¦¬à§‡à¦¦à¦¨ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ Admin Review à¦•à¦°à¦›à§‡à¥¤");
        @unlink($stepFile);
        exit;
    }

    // --- AWAIT GMAIL SUBMIT ---
    if($step == "await_gmail"){
        sendMessage($adminId, "ðŸ“¤ User $chatId Gmail à¦ªà¦¾à¦ à¦¿à¦¯à¦¼à§‡à¦›à§‡:\n$text\n\nâ¬‡ï¸ à¦¸à¦¿à¦¦à§à¦§à¦¾à¦¨à§à¦¤ à¦¨à¦¿à¦¨:", [
            'inline_keyboard' => [
                [
                    ['text'=>"âœ… Accept", 'callback_data'=>"accept|$chatId"],
                    ['text'=>"âŒ Reject", 'callback_data'=>"reject|$chatId"]
                ]
            ]
        ]);
        sendMessage($chatId, "ðŸ“¤ Gmail Submit à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡, Admin à¦¯à¦¾à¦šà¦¾à¦‡ à¦•à¦°à¦›à§‡à¥¤");
        @unlink($stepFile);
        exit;
    }
}

// --- HANDLE INLINE APPLY BUTTON ---
if(isset($update['callback_query'])){
    $data = $update['callback_query']['data'];
    if(strpos($data, "apply") === 0){
        $userId = explode("|",$data)[1];
        file_put_contents("apply_step_$userId.txt", "await_name");
        sendMessage($userId, "à¦†à¦ªà¦¨à¦¾à¦° à¦¨à¦¾à¦® à¦²à¦¿à¦–à§à¦¨:");
    }
}
?>
